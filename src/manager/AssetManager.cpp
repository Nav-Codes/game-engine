//
// Created by navjo on 2/18/2026.
//

#include "AssetManager.hpp"

#include "tinyxml2.h"

using namespace std;

unordered_map<string, Animation> AssetManager::animations;

void AssetManager::loadAnimation(const string &clipName, const char *path) {
    Animation animation = loadAnimaitonFromXML(path);
    animations[clipName] = animation;
}

const Animation &AssetManager::getAnimation(const string &clipName) {
    return animations[clipName];
}

Animation AssetManager::loadAnimaitonFromXML(const char *path) {
    Animation anim;
    tinyxml2::XMLDocument doc;
    doc.LoadFile(path);

    auto* root = doc.FirstChildElement("animations");

    for (auto* clipElem = root->FirstChildElement(); clipElem; clipElem = clipElem->NextSiblingElement()) {
        string clipName = clipElem->Name();
        AnimationClip clip;

        for (auto* frameElem = clipElem->FirstChildElement("frame"); frameElem; frameElem = frameElem->NextSiblingElement("frame")) {
            SDL_FRect rect;
            frameElem->QueryFloatAttribute("x", &rect.x);
            frameElem->QueryFloatAttribute("y", &rect.y);
            frameElem->QueryFloatAttribute("w", &rect.w);
            frameElem->QueryFloatAttribute("h", &rect.h);
            clip.frameIndices.push_back(rect);
        }

        anim.clips[clipName] = clip;
    }

    if (!anim.clips.empty()) {
        anim.currentClip = anim.clips.begin()->first;
    }

    return anim;
}

